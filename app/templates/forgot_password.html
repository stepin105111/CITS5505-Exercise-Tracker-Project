{% extends "base.html" %}

{% block title %}Reset Password - Fitness Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="login-register-wrapper">
  <div class="container">
    <h1>Reset Password</h1>

    {% if error %}
    <p class="error"><i class="fas fa-exclamation-circle"></i> {{ error }}</p>
    {% endif %}

    {% if step == 'username' %}
    <form method="post" action="{{ url_for('forgot_password') }}">
      {{ form.hidden_tag() }}
      <div class="input-group">
        <i class="fas fa-user"></i>
        {{ form.username(placeholder="Username", type="text", class="username-input") }}
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i> {{ form.submit.label.text }}
      </button>
    </form>

    {% elif step == 'security_question' %}
    <form method="post" action="{{ url_for('verify_answer') }}">
      {{ form.hidden_tag() }}
      {{ form.username(type="hidden") }}
      <p class="question">{{ security_question }}</p>
      <div class="input-group">
        <i class="fas fa-question-circle"></i>
        {{ form.answer(placeholder="Your answer", class="form-control") }}
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-check"></i> {{ form.submit.label.text }}
      </button>
    </form>

    {% elif step == 'reset_password' %}
    <form method="post" action="{{ url_for('reset_password') }}" id="reset-password-form">
      {{ form.hidden_tag() }}
      {{ form.username(type="hidden") }}

      <div class="input-group">
        <i class="fas fa-lock"></i>
        {{ form.new_password(placeholder="New Password", type="password", id="password", class="password-input") }}
        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('password')"></i>
      </div>

      <div class="password-strength">
        <div class="strength-meter" id="strength-meter"></div>
        <p id="strength-text">Password strength</p>
      </div>

      <div class="input-group">
        <i class="fas fa-lock"></i>
        {{ form.confirm_password(placeholder="Confirm New Password", type="password", id="confirm_password", class="confirm_password-input") }}
        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirm_password')"></i>
      </div>

      <button type="submit" class="btn btn-primary">
        <i class="fas fa-key"></i> {{ form.submit.label.text }}
      </button>
    </form>
    {% endif %}

    <p class="login-link"><a href="{{ url_for('login') }}">Back to login</a></p>
  </div>
</div>

<script>
  function togglePasswordVisibility(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const toggleIcon = passwordField.nextElementSibling;

    if (passwordField.type === 'password') {
      passwordField.type = 'text';
      toggleIcon.classList.remove('fa-eye');
      toggleIcon.classList.add('fa-eye-slash');
    } else {
      passwordField.type = 'password';
      toggleIcon.classList.remove('fa-eye-slash');
      toggleIcon.classList.add('fa-eye');
    }
  }

  if (document.getElementById('password')) {
    document.getElementById('password').addEventListener('input', function () {
      const password = this.value;
      const meter = document.getElementById('strength-meter');
      const text = document.getElementById('strength-text');
      let strength = 0;
      if (password.length > 6) strength += 25;
      if (password.match(/[A-Z]/)) strength += 25;
      if (password.match(/[0-9]/)) strength += 25;
      if (password.match(/[^A-Za-z0-9]/)) strength += 25;
      meter.style.width = strength + '%';
      if (strength <= 25) {
        meter.style.backgroundColor = '#ff4d4d';
        text.textContent = 'Weak password';
      } else if (strength <= 50) {
        meter.style.backgroundColor = '#ffa64d';
        text.textContent = 'Medium password';
      } else if (strength <= 75) {
        meter.style.backgroundColor = '#99cc00';
        text.textContent = 'Good password';
      } else {
        meter.style.backgroundColor = '#00cc44';
        text.textContent = 'Strong password';
      }
    });
  }

  if (document.getElementById('confirm_password')) {
    document.getElementById('reset-password-form').addEventListener('submit', function (e) {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm_password').value;
      if (password !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
      }
    });
  }
</script>
{% endblock %}
